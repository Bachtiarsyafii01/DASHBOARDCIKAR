<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Realisasi</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
  .container { max-width: 1200px; margin: auto; }
  .header { text-align: center; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
  .logo { height: 50px; }
  .recap-section { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  input, select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  .upload-container { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
  .filter-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .info-box-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
  .info-box { background-color: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd; text-align: center; }
  .info-box .label { font-weight: bold; color: #555; margin-bottom: 5px; }
  .info-box .value { font-size: 1.8em; font-weight: bold; color: #333; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  #downloadPdfButton { background-color: #d9534f; color: white; }
  #downloadExcelButton { background-color: #5cb85c; color: white; }
  #removeFileButton { background-color: #f0ad4e; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }

  @media (max-width: 600px) {
    .info-box-grid { grid-template-columns: 1fr; }
    table, th, td { font-size: 14px; }
    .header { flex-direction: column; gap: 10px; }
  }
</style>
</head>
<body>

<script>
// Cek login
if (localStorage.getItem('isLoggedIn') !== 'true') {
    window.location.href = 'login.html';
}
</script>

<div class="container">
  <div class="header">
    <img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Danantara_Indonesia.svg" class="logo">
    <h2>Dashboard Realisasi Cikar</h2>
    <img src="https://bri.co.id/o/bri-corporate-theme/images/bri-logo.png" class="logo">
  </div>

  <div class="recap-section" id="recapSection">
    <button onclick="window.location.href='index.html'" 
            style="margin-bottom:15px; background-color:#007bff; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">
        â¬… Kembali
    </button>
    <div class="upload-container">
        <label><b>Input file disini:</b></label>
        <input type="file" id="fileInput" accept=".csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.oasis.opendocument.spreadsheet">
        <button id="removeFileButton" style="display:none;">Hapus File</button>
    </div>

    <div class="filter-container">
        <label for="mbnameFilter"><b>Filter Branch:</b></label>
        <input list="branchList" id="mbnameFilter" placeholder="Ketik atau pilih branch...">
        <datalist id="branchList">
            <option value="all">-- Semua Branch --</option>
        </datalist>
        <button id="downloadPdfButton">Export PDF</button>
        <button id="downloadExcelButton">Export Excel</button>
    </div>

    <div class="info-box-grid">
        <div class="info-box">
            <div class="label">Total Unit Kerja</div>
            <div class="value" id="totalBrnameValue">0</div>
        </div>
        <div class="info-box">
            <div class="label">Total Plafond</div>
            <div class="value" id="totalPlafondValue">0</div>
        </div>
    </div>

    <h3>Rincian Unit Kerja</h3>
    <table id="recapTable">
      <thead>
        <tr>
          <th>Unit Kerja</th>
          <th>Plafond</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let rawData = [];
let allMbnames = new Set();
let currentFilter = 'all';

document.getElementById('fileInput').addEventListener('change', handleFile);
document.getElementById('mbnameFilter').addEventListener('input', () => { 
    currentFilter = document.getElementById('mbnameFilter').value || 'all';
    filterData(); 
});
document.getElementById('downloadPdfButton').addEventListener('click', downloadPdf);
document.getElementById('downloadExcelButton').addEventListener('click', downloadExcel);
document.getElementById('removeFileButton').addEventListener('click', removeFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById('removeFileButton').style.display = 'inline-block';

  const reader = new FileReader();
  const ext = file.name.split('.').pop().toLowerCase();

  if (ext === 'csv') {
    reader.onload = ev => processCsv(ev.target.result);
    reader.readAsText(file);
  } else {
    reader.onload = ev => {
      const data = new Uint8Array(ev.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: '' });
      processSheetData(sheet);
    };
    reader.readAsArrayBuffer(file);
  }
}

function processCsv(csv) {
  const lines = csv.split('\n');
  const headers = lines[0].split(',').map(h => h.trim());
  const brIdx = headers.indexOf('brname');
  const plfIdx = headers.indexOf('plafond');
  const mbIdx = headers.indexOf('mbname');
  if (brIdx === -1 || plfIdx === -1 || mbIdx === -1) {
    alert("Kolom 'brname', 'plafond', atau 'mbname' tidak ditemukan.");
    return;
  }
  rawData = [];
  allMbnames.clear();
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i].split(',');
    if (row.length < 3) continue;
    addRaw(row[mbIdx], row[brIdx], row[plfIdx]);
  }
  populateFilter();
  filterData();
}

function processSheetData(data) {
  rawData = [];
  allMbnames.clear();
  data.forEach(row => {
    addRaw(row['mbname'], row['brname'], row['plafond']);
  });
  populateFilter();
  filterData();
}

function addRaw(mbname, brname, plafondStr) {
  const mb = (mbname || '').toString().trim();
  const br = (brname || '').toString().trim();
  const plafond = parseFloat((plafondStr || '').toString().replace(/[^\d.]/g,'')) || 0;
  rawData.push({ mbname: mb, brname: br, plafond });
  allMbnames.add(mb);
}

function populateFilter() {
  const datalist = document.getElementById('branchList');
  datalist.innerHTML = '<option value="all">-- Semua Branch --</option>';
  Array.from(allMbnames).sort().forEach(mb => {
    const opt = document.createElement('option');
    opt.value = mb;
    datalist.appendChild(opt);
  });
}

function filterData() {
  let filtered = (currentFilter === 'all') ? rawData : rawData.filter(d => d.mbname.toLowerCase() === currentFilter.toLowerCase());
  const recap = {};
  let totalPlafond = 0;
  filtered.forEach(d => {
    recap[d.brname] = (recap[d.brname] || 0) + d.plafond;
    totalPlafond += d.plafond;
  });
  updateRecapInfo(Object.keys(recap).length, totalPlafond);
  displayTable(filtered);
}

function updateRecapInfo(total, plafond) {
  document.getElementById('totalBrnameValue').textContent = total;
  document.getElementById('totalPlafondValue').textContent = plafond.toLocaleString('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0});
}

function displayTable(data) {
  const tbody = document.querySelector('#recapTable tbody');
  tbody.innerHTML = '';
  data.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.brname}</td>
      <td>${d.plafond.toLocaleString('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0})}</td>
    `;
    tbody.appendChild(tr);
  });
}

function removeFile() {
  document.getElementById('fileInput').value = '';
  document.getElementById('removeFileButton').style.display = 'none';
  rawData = [];
  allMbnames.clear();
  document.getElementById('branchList').innerHTML = '<option value="all">-- Semua Branch --</option>';
  document.getElementById('totalBrnameValue').textContent = '0';
  document.getElementById('totalPlafondValue').textContent = '0';
  document.querySelector('#recapTable tbody').innerHTML = '';
}

function downloadPdf() {
  const element = document.getElementById('recapTable');
  html2pdf().set({ filename: 'rekapitulasi-plafond.pdf' }).from(element).save();
}

function downloadExcel() {
  let filtered = (currentFilter === 'all') ? rawData : rawData.filter(d => d.mbname.toLowerCase() === currentFilter.toLowerCase());
  const ws = XLSX.utils.json_to_sheet(filtered);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data");
  XLSX.writeFile(wb, "rekapitulasi-plafond.xlsx");
}
</script>

</body>
</html>
